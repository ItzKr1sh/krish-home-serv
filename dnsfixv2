#!/bin/bash

# DNS Configuration Fix for Krish Home Server
# Author: Enterprise Systems Engineer
# Created: 2025-07-24 17:10:20 UTC
# For: ItzKr1sh

# Set strict error handling
set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Print functions
print_status() { echo -e "${GREEN}[✓]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[⚠]${NC} $1"; }
print_info() { echo -e "${BLUE}[ℹ]${NC} $1"; }
print_error() { echo -e "${RED}[✗]${NC} $1"; }

print_info "Starting DNS configuration fix..."

# First, check if running as root
if [[ $EUID -eq 0 ]]; then
    print_error "This script should not be run as root. Please run as a regular user with sudo privileges."
    exit 1
fi

# Ensure sudo access
if ! sudo -n true 2>/dev/null; then
    print_error "This script requires sudo privileges. Please run: sudo -v"
    exit 1
fi

# Create temporary DNS config file
print_info "Creating temporary DNS configuration..."
TMP_RESOLV="/tmp/resolv.conf.$$"

cat > "$TMP_RESOLV" << EOF
# Generated by Krish Home Server DNS fix
# Date: $(date -u)
nameserver 8.8.8.8
nameserver 1.1.1.1
nameserver 8.8.4.4
nameserver 9.9.9.9
options timeout:2 attempts:3
EOF

# Backup existing resolv.conf if it exists
print_info "Backing up current DNS configuration..."
if [ -f "/etc/resolv.conf" ]; then
    sudo cp /etc/resolv.conf "/etc/resolv.conf.backup.$(date +%Y%m%d_%H%M%S)"
fi

# Copy the temporary file to /etc/resolv.conf using sudo
print_info "Applying new DNS configuration..."
sudo cp "$TMP_RESOLV" /etc/resolv.conf
sudo chown root:root /etc/resolv.conf
sudo chmod 644 /etc/resolv.conf

# Clean up temporary file
rm -f "$TMP_RESOLV"

# Test DNS resolution
print_info "Testing DNS configuration..."
if ping -c 1 minecraft.azureedge.net &>/dev/null; then
    print_status "DNS configuration successful!"
else
    print_warning "DNS resolution test failed. But configuration was applied."
fi

print_status "DNS fix completed. You can now proceed with the Minecraft server installation."